-- Library Setup
local Library = loadstring(game:HttpGet("https://raw.githubusercontent.com/Scripting137/Nevox/refs/heads/main/Ui"))()

local Window = Library:Window({
    Name = "Nevox - Madness.idk",
    SubName = "Booga Booga Reborn",
    Logo = "120959262762131"
})

-- Services
local rs = game:GetService("ReplicatedStorage")
local packets = require(rs.Modules.Packets)
local plr = game.Players.LocalPlayer
local char = plr.Character or plr.CharacterAdded:Wait()
local root = char:WaitForChild("HumanoidRootPart")
local hum = char:WaitForChild("Humanoid")
local runs = game:GetService("RunService")
local RunService = game:GetService("RunService")
local uis = game:GetService("UserInputService")
local tspmo = game:GetService("TweenService")
local pathService = game:GetService("PathfindingService")

-- Variables
local originalValues = {
    WalkSpeed = hum.WalkSpeed,
    JumpPower = hum.JumpPower,
    HipHeight = hum.HipHeight,
    MaxSlopeAngle = hum.MaxSlopeAngle
}

-- Door Utility Variables
local hiddenDoors = {}
local delHut = false
local delGate = false

-- Double Jump
local canDoubleJump = false
local hasDoubleJumped = false
local doubleJumpConnections = {}

-- Kill Aura
local killAuraEnabled = false
local killAuraRange = 8
local killAuraMaxTargets = 3
local killAuraCooldown = 0.1

-- Auto Heal/Eat
local autoHealEnabled = false
local autoEatEnabled = false
local autoHealFruit = "Bloodfruit"
local autoEatFruit = "Coconut"
local autoHealThreshold = 90
local autoEatThreshold = 90
local autoEatCPS = 3

-- Auto Pickup
local autoPickupEnabled = false
local pickupRange = 20
local selectedItems = {}
local PickAllMode = false
local chestPickupEnabled = false
local customPickupEnabled = false
local customPickupText = ""

-- Auto Drop
local autoDropEnabled = false
local dropItem = "All"
local autoDropCustomEnabled = false
local customDropItem = "Bloodfruit"
local dropCooldown = 0.001

-- Farming
local plantToggle = false
local plantRange = 30
local plantDelay = 0.01
local selectedFruit = "Bloodfruit"
local harvestToggle = false
local harvestRange = 30

-- Tween Farming
local tweenPlantBoxEnabled = false
local tweenBushEnabled = false
local tweenRange = 250
local currentTween = nil
local tweenSpeed = 15 -- Slower speed to avoid anti-cheat

-- Resource/Critter Aura
local resourceAuraEnabled = false
local resourceRange = 20
local resourceMaxTargets = 3
local resourceCooldown = 0.1

local critterAuraEnabled = false
local critterRange = 40
local critterMaxTargets = 3
local critterCooldown = 0.1

-- Player ESP
local espEnabled = false
local espShowHP = true
local espShowArmor = true
local espShowWeapon = true
local espMaxDistance = 2500

-- World ESP Settings (KEEPING YOUR OLD SETTINGS STRUCTURE)
local WorldESP = {
    Items = {Enabled = false, Range = 500, Filter = {}, All = false},
    Critters = {Enabled = false, Range = 1000, Filter = {}, All = false},
    Resources = {Enabled = false, Range = 5000, Filter = {}, All = false, Gods = false}
}

-- All Items List (for both pickup and ESP)
local allItems = {
    "ALL ITEMS",
    "Wood", "Log", "Stone", "Iron", "Gold", "Bloodfruit", "Bluefruit", "Lemon", "Strawberry", 
    "Adurite", "Coin", "Essence", "Crystal Chunk", "Leaves", "Hide", "Steel", "Magnetite", 
    "Pink Diamond", "Emerald", "Void Shard", "Jelly", "Ice Cube", "Coal", "Coconut",
    "Banana", "Orange", "Berry", "Oddberry", "Strangefruit", "Sunfruit", "Pumpkin",
    "Prickly Pear", "Apple", "Barley", "Cloudberry", "Carrot", "Snow Berry", "Cloudfruit"
}

-- Fruit ID Map
local fruitToItemId = {
    Bloodfruit = 94,
    Bluefruit = 377,
    Lemon = 99,
    Coconut = 1,
    Jelly = 604,
    Banana = 606,
    Orange = 602,
    Berry = 35,
    Oddberry = 32,
    Strangefruit = 302,
    Strawberry = 282,
    Sunfruit = 128,
    Pumpkin = 80,
    ["Prickly Pear"] = 378,
    Apple = 243,
    Barley = 247,
    Cloudberry = 101,
    Carrot = 147,
    ["Snow Berry"] = 490,
    Cloudfruit = 514
}

-- Categories & Pages
Window:Category("Main Features")
local MainPage = Window:Page({Name = "Main", Icon = "134236649319095"})
local CombatPage = Window:Page({Name = "Combat", Icon = "100050851789190"})
local PickupPage = Window:Page({Name = "Pickup", Icon = "108839695397679"})
local FarmingPage = Window:Page({Name = "Farming", Icon = "123554105934637"})

Window:Category("Visual")
local ESPPage = Window:Page({Name = "ESP", Icon = "138827881557940", Columns = 2})

Window:Category("Utilities & Settings")
local SettingsPage = Library:CreateSettingsPage(Window)

-- =================== DOOR UTILITY FUNCTIONS ===================
-- [[ CORE DOOR FUNCTION ]] --
local function ProcessDoors(filter, shouldHide)
    local deployables = workspace:FindFirstChild("Deployables")
    if not deployables then return end

    if shouldHide then
        for _, item in ipairs(deployables:GetChildren()) do
            if item.Name:find(filter) then
                local door = item:FindFirstChild("Door")
                if door then
                    hiddenDoors[door] = item
                    door.Parent = nil
                end
            end
        end
    else
        for door, parent in pairs(hiddenDoors) do
            if parent and parent.Name:find(filter) then
                door.Parent = parent
                hiddenDoors[door] = nil
            end
        end
    end
end

-- =================== PLAYER STATS FUNCTIONS ===================
local walkConn, jumpConn, hipConn, slopeConn

local function updateWalkspeed(enabled)
    if walkConn then walkConn:Disconnect() end
    if enabled then
        hum.WalkSpeed = wsslider:Get()
        walkConn = runs.RenderStepped:Connect(function() 
            if hum and hum.Parent then
                hum.WalkSpeed = wsslider:Get() 
            end
        end)
    else
        hum.WalkSpeed = originalValues.WalkSpeed
    end
end

local function updateJumpPower(enabled)
    if jumpConn then jumpConn:Disconnect() end
    if enabled then
        hum.JumpPower = jpslider:Get()
        jumpConn = runs.RenderStepped:Connect(function() 
            if hum and hum.Parent then
                hum.JumpPower = jpslider:Get() 
            end
        end)
    else
        hum.JumpPower = originalValues.JumpPower
    end
end

local function updateHipHeight(enabled)
    if hipConn then hipConn:Disconnect() end
    if enabled then
        hum.HipHeight = hheightslider:Get()
        hipConn = runs.RenderStepped:Connect(function() 
            if hum and hum.Parent then
                hum.HipHeight = hheightslider:Get() 
            end
        end)
    else
        hum.HipHeight = originalValues.HipHeight
    end
end

local function updateNoSlip(enabled)
    if slopeConn then slopeConn:Disconnect() end
    if enabled then
        hum.MaxSlopeAngle = 89.9
        slopeConn = runs.RenderStepped:Connect(function() 
            if hum and hum.Parent then
                hum.MaxSlopeAngle = 89.9 
            end
        end)
    else
        hum.MaxSlopeAngle = originalValues.MaxSlopeAngle
    end
end

local function updateDoubleJump(enabled)
    for _, c in pairs(doubleJumpConnections) do c:Disconnect() end
    doubleJumpConnections = {}
    
    if enabled then
        local ground = runs.RenderStepped:Connect(function()
            if hum and hum.Parent and hum.FloorMaterial ~= Enum.Material.Air then 
                hasDoubleJumped = false 
                canDoubleJump = true 
            end
        end)
        
        local input = uis.InputBegan:Connect(function(inp, gp)
            if gp then return end
            if hum and hum.Parent and inp.KeyCode == Enum.KeyCode.Space and hum.FloorMaterial == Enum.Material.Air and canDoubleJump and not hasDoubleJumped then
                local currentVelocity = root.Velocity
                root.Velocity = Vector3.new(currentVelocity.X, jpslider:Get(), currentVelocity.Z)
                hasDoubleJumped = true
                canDoubleJump = false
            end
        end)
        
        table.insert(doubleJumpConnections, ground)
        table.insert(doubleJumpConnections, input)
    end
end

-- =================== MAIN PAGE ===================
local PlayerSection = MainPage:Section({Name = "Player  ", Side = 1})

local wstoggle = PlayerSection:Toggle({
    Name = "Walkspeed",
    Default = false,
    Callback = function(v) updateWalkspeed(v) end
})

local wsslider = PlayerSection:Slider({
    Name = "Walkspeed Value",
    Min = 10,
    Max = 24,
    Suffix = "studs",
    Default = 16,
    Decimals = 1,
    Callback = function(v) 
        if wstoggle:Get() then 
            hum.WalkSpeed = v 
        end 
    end
})

local jptoggle = PlayerSection:Toggle({
    Name = "JumpPower",
    Default = false,
    Callback = function(v) updateJumpPower(v) end
})

local jpslider = PlayerSection:Slider({
    Name = "JumpPower Value",
    Min = 30,
    Max = 80,
    Suffix = "power",
    Default = 50,
    Decimals = 1,
    Callback = function(v) 
        if jptoggle:Get() then 
            hum.JumpPower = v 
        end 
    end
})

local hheighttoggle = PlayerSection:Toggle({
    Name = "HipHeight",
    Default = false,
    Callback = function(v) updateHipHeight(v) end
})

local hheightslider = PlayerSection:Slider({
    Name = "HipHeight Value",
    Min = 0.1,
    Max = 10,
    Suffix = "studs",
    Default = 2,
    Decimals = 1,
    Callback = function(v) 
        if hheighttoggle:Get() then 
            hum.HipHeight = v 
        end 
    end
})

local msatoggle = PlayerSection:Toggle({
    Name = "No Mountain Slip",
    Default = false,
    Callback = function(v) updateNoSlip(v) end
})

local doublejumptoggle = PlayerSection:Toggle({
    Name = "Double Jump",
    Default = false,
    Callback = function(v) updateDoubleJump(v) end
})

-- Structure Manipulation Section moved to Main Page
local StructureSection = MainPage:Section({Name = "Door Shit", Side = 2})

-- [[ UI TOGGLES ]] --
StructureSection:Toggle({
    Name = "Delete Hut Doors",
    Default = false,
    Callback = function(v)
        delHut = v
        ProcessDoors("Hut", v)
    end
})

StructureSection:Toggle({
    Name = "Delete Gate Doors",
    Default = false,
    Callback = function(v)
        delGate = v
        ProcessDoors("Gate", v)
    end
})

local UtilitySection = MainPage:Section({Name = "Utilities", Side = 2})

UtilitySection:Button({
    Name = "Reset Character",
    Callback = function() 
        if char then 
            char:BreakJoints() 
        end 
    end
})

UtilitySection:Button({
    Name = "Copy Job ID",
    Callback = function() 
        setclipboard(game.JobId) 
    end
})

-- =================== COMBAT PAGE ===================
local CombatSection = CombatPage:Section({Name = "Kill Aura", Side = 1})

local kauratoggle = CombatSection:Toggle({
    Name = "Kill Aura",
    Default = false,
    Callback = function(v) killAuraEnabled = v end
})

local kaurarange = CombatSection:Slider({
    Name = "Range",
    Min = 1,
    Max = 12,
    Suffix = "studs",
    Default = 8,
    Decimals = 1,
    Callback = function(v) killAuraRange = v end
})

local kaumax = CombatSection:Dropdown({
    Name = "Max Targets",
    Default = "3",
    Items = {"1","2","3","4","5","6"},
    Callback = function(v) killAuraMaxTargets = tonumber(v) end
})

local kaCooldownSlider = CombatSection:Slider({
    Name = "Attack Cooldown",
    Min = 0.01,
    Max = 1,
    Suffix = "s",
    Default = 0.1,
    Decimals = 2,
    Callback = function(v) killAuraCooldown = v end
})

local AutoHealSection = CombatPage:Section({Name = "Auto Heal & Eat", Side = 2})

local healToggle = AutoHealSection:Toggle({
    Name = "Auto Heal",
    Default = false,
    Callback = function(v) autoHealEnabled = v end
})

local healFruit = AutoHealSection:Dropdown({
    Name = "Heal Fruit",
    Default = "Bloodfruit",
    Items = {"Bloodfruit","Bluefruit","Lemon","Coconut","Jelly","Banana","Orange","Berry","Oddberry","Strangefruit","Strawberry","Sunfruit","Pumpkin","Prickly Pear","Apple","Barley","Cloudberry","Carrot","Snow Berry","Cloudfruit"},
    Callback = function(v) autoHealFruit = v end
})

local healThresh = AutoHealSection:Slider({
    Name = "Heal Below %",
    Min = 1,
    Max = 100,
    Suffix = "%",
    Default = 90,
    Decimals = 1,
    Callback = function(v) autoHealThreshold = v end
})

local eatToggle = AutoHealSection:Toggle({
    Name = "Auto Eat",
    Default = false,
    Callback = function(v) autoEatEnabled = v end
})

local eatFruit = AutoHealSection:Dropdown({
    Name = "Eat Fruit",
    Default = "Coconut",
    Items = {"Coconut","Bloodfruit","Bluefruit","Lemon","Jelly","Banana","Orange","Berry","Oddberry","Strangefruit","Strawberry","Sunfruit","Pumpkin","Prickly Pear","Apple","Barley","Cloudberry","Carrot","Snow Berry","Cloudfruit"},
    Callback = function(v) autoEatFruit = v end
})

local eatThresh = AutoHealSection:Slider({
    Name = "Eat Below %",
    Min = 1,
    Max = 100,
    Suffix = "%",
    Default = 90,
    Decimals = 1,
    Callback = function(v) autoEatThreshold = v end
})

local eatCPS = AutoHealSection:Slider({
    Name = "Eat Speed (CPS)",
    Min = 1,
    Max = 120,
    Suffix = "cps",
    Default = 3,
    Decimals = 1,
    Callback = function(v) autoEatCPS = v end
})

-- =================== PICKUP PAGE ===================
local PickupSection = PickupPage:Section({Name = "Auto Pickup", Side = 1})

local autopickuptoggle = PickupSection:Toggle({
    Name = "Auto Pickup",
    Default = false,
    Callback = function(v) autoPickupEnabled = v end
})

local chestpickuptoggle = PickupSection:Toggle({
    Name = "Chest Pickup",
    Default = false,
    Callback = function(v) chestPickupEnabled = v end
})

local pickuprangeslider = PickupSection:Slider({
    Name = "Pickup Range",
    Min = 1,
    Max = 150,
    Suffix = "studs",
    Default = 40,
    Decimals = 1,
    Callback = function(v) pickupRange = v end
})

-- FIXED: Correct dropdown implementation
local itemdropdown = PickupSection:Dropdown({
    Name = "Items to Pickup",
    Items = allItems,
    Multi = true,
    Callback = function(Value)
        selectedItems = {}
        PickAllMode = false
        
        if type(Value) == "table" then
            for _, itemName in ipairs(Value) do
                if itemName == "ALL ITEMS" then
                    PickAllMode = true
                else
                    selectedItems[itemName] = true
                end
            end
        end
    end
})

-- Custom Pickup
local custompickuptoggle = PickupSection:Toggle({
    Name = "Custom Item Pickup",
    Default = false,
    Callback = function(v) customPickupEnabled = v end
})

local custompickuptextbox = PickupSection:Textbox({
    Name = "Custom Item Name",
    Default = "",
    Placeholder = "Enter item name...",
    Callback = function(v) customPickupText = v end
})

local DropSection = PickupPage:Section({Name = "Auto Drop", Side = 2})

local droptoggle = DropSection:Toggle({
    Name = "Auto Drop",
    Default = false,
    Callback = function(v) autoDropEnabled = v end
})

local dropdropdown = DropSection:Dropdown({
    Name = "Select Item to Drop",
    Default = "All",
    Items = {"All", "Bloodfruit", "Bluefruit", "Lemon", "Coconut", "Jelly", "Banana", "Orange", "Berry", "Oddberry", "Strangefruit", "Strawberry", "Sunfruit", "Pumpkin", "Prickly Pear", "Apple", "Barley", "Cloudberry", "Carrot", "Snow Berry", "Cloudfruit"},
    Callback = function(v) dropItem = v end
})

local droptogglecustom = DropSection:Toggle({
    Name = "Auto Drop Custom",
    Default = false,
    Callback = function(v) autoDropCustomEnabled = v end
})

local droptextbox = DropSection:Textbox({
    Name = "Custom Item",
    Default = "Bloodfruit",
    Placeholder = "...",
    Callback = function(v) customDropItem = v end
})

-- =================== FARMING PAGE ===================
local FarmingSection = FarmingPage:Section({Name = "Auto Farming", Side = 1})

local fruitdropdown = FarmingSection:Dropdown({
    Name = "Select Fruit",
    Default = "Bloodfruit",
    Items = {"Bloodfruit", "Bluefruit", "Lemon", "Coconut", "Jelly", "Banana", "Orange", "Berry", "Oddberry", "Strangefruit", "Strawberry", "Sunfruit", "Pumpkin", "Prickly Pear", "Apple", "Barley", "Cloudberry", "Carrot", "Snow Berry", "Cloudfruit"},
    Callback = function(v) selectedFruit = v end
})

local planttoggle = FarmingSection:Toggle({
    Name = "Auto Plant",
    Default = false,
    Callback = function(v) plantToggle = v end
})

local plantrangeslider = FarmingSection:Slider({
    Name = "Plant Range",
    Min = 1,
    Max = 30,
    Suffix = "studs",
    Default = 30,
    Decimals = 1,
    Callback = function(v) plantRange = v end
})

local plantdelayslider = FarmingSection:Slider({
    Name = "Plant Delay (s)",
    Min = 0.01,
    Max = 0.5,
    Suffix = "s",
    Default = 0.01,
    Decimals = 3,
    Callback = function(v) plantDelay = v end
})

local harvesttoggle = FarmingSection:Toggle({
    Name = "Auto Harvest",
    Default = false,
    Callback = function(v) harvestToggle = v end
})

local harvestrangeslider = FarmingSection:Slider({
    Name = "Harvest Range",
    Min = 1,
    Max = 30,
    Suffix = "studs",
    Default = 30,
    Decimals = 1,
    Callback = function(v) harvestRange = v end
})

-- Tween Farming
local TweenSection = FarmingPage:Section({Name = "PlantBox Shit", Side = 2})

local tweenplantboxtoggle = TweenSection:Toggle({
    Name = "Tween to Plant Box",
    Default = false,
    Callback = function(v) 
        tweenPlantBoxEnabled = v
        if currentTween then
            currentTween:Cancel()
            currentTween = nil
        end
    end
})

local tweenbushtoggle = TweenSection:Toggle({
    Name = "Tween to Bush + Plant Box",
    Default = false,
    Callback = function(v) 
        tweenBushEnabled = v
        if currentTween then
            currentTween:Cancel()
            currentTween = nil
        end
    end
})

local tweenrangeslider = TweenSection:Slider({
    Name = "Tween Range",
    Min = 1,
    Max = 250,
    Suffix = "studs",
    Default = 250,
    Decimals = 1,
    Callback = function(v) tweenRange = v end
})

local tweenSpeedSlider = TweenSection:Slider({
    Name = "Tween Speed",
    Min = 5,
    Max = 30,
    Suffix = "studs/s",
    Default = 15,
    Decimals = 1,
    Callback = function(v) tweenSpeed = v end
})

-- Resource/Critter Aura Section
local ResourceSection = FarmingPage:Section({Name = "Resource & Critter Aura", Side = 2})

local resourceauratoggle = ResourceSection:Toggle({
    Name = "Resource Aura",
    Default = false,
    Callback = function(v) resourceAuraEnabled = v end
})

local resourceaurarange = ResourceSection:Slider({
    Name = "Resource Range",
    Min = 1,
    Max = 20,
    Suffix = "studs",
    Default = 20,
    Decimals = 1,
    Callback = function(v) resourceRange = v end
})

local resourcetargetdropdown = ResourceSection:Dropdown({
    Name = "Max Targets",
    Default = "3",
    Items = {"1","2","3","4","5","6"},
    Callback = function(v) resourceMaxTargets = tonumber(v) end
})

local resourcecooldown = ResourceSection:Slider({
    Name = "Cooldown (s)",
    Min = 0.01,
    Max = 1,
    Suffix = "s",
    Default = 0.1,
    Decimals = 2,
    Callback = function(v) resourceCooldown = v end
})

local critterauratoggle = ResourceSection:Toggle({
    Name = "Critter Aura",
    Default = false,
    Callback = function(v) critterAuraEnabled = v end
})

local critterrangeslider = ResourceSection:Slider({
    Name = "Critter Range",
    Min = 1,
    Max = 50,
    Suffix = "studs",
    Default = 40,
    Decimals = 1,
    Callback = function(v) critterRange = v end
})

local crittertargetdropdown = ResourceSection:Dropdown({
    Name = "Max Targets",
    Default = "3",
    Items = {"1","2","3","4","5","6"},
    Callback = function(v) critterMaxTargets = tonumber(v) end
})

local crittercooldown = ResourceSection:Slider({
    Name = "Cooldown (s)",
    Min = 0.01,
    Max = 1,
    Suffix = "s",
    Default = 0.1,
    Decimals = 2,
    Callback = function(v) critterCooldown = v end
})

-- =================== ESP PAGE ===================
-- Player ESP Section
local PlayerESPSection = ESPPage:Section({Name = "Player ESP", Side = 1})

local playeresptoggle = PlayerESPSection:Toggle({
    Name = "Enable Player ESP",
    Default = false,
    Callback = function(v) 
        espEnabled = v 
        if not v then 
            clearESP() 
        else 
            createESPForAllPlayers() 
        end 
    end
})

local esphealth = PlayerESPSection:Toggle({
    Name = "Show HP",
    Default = true,
    Callback = function(v) espShowHP = v end
})

local esparmor = PlayerESPSection:Toggle({
    Name = "Show Armor",
    Default = true,
    Callback = function(v) espShowArmor = v end
})

local espweapon = PlayerESPSection:Toggle({
    Name = "Show Weapon",
    Default = true,
    Callback = function(v) espShowWeapon = v end
})

local esprange = PlayerESPSection:Slider({
    Name = "Max Distance",
    Min = 0,
    Max = 5000,
    Suffix = "m",
    Default = 2500,
    Decimals = 1,
    Callback = function(v) espMaxDistance = v end
})

-- World Items ESP Section (USING YOUR OLD ESP CODE)
local WorldItemsSection = ESPPage:Section({Name = "Dropped Items ESP", Side = 1})

WorldItemsSection:Toggle({
    Name = "Enabled",
    Default = false,
    Callback = function(v) WorldESP.Items.Enabled = v end
})

WorldItemsSection:Slider({
    Name = "Range",
    Min = 50,
    Max = 5000,
    Default = 500,
    Callback = function(v) WorldESP.Items.Range = v end
})

WorldItemsSection:Dropdown({
    Name = "Item Filter",
    Items = {"ALL ITEMS", "Wood", "Log", "Stone", "Iron", "Gold", "Adurite", "Coin", "Essence", "Magnetite", "Bloodfruit", "Bluefruit", "Lemon", "Strawberry", "Crystal Chunk", "Leaves", "Hide", "Steel", "Pink Diamond", "Emerald", "Void Shard", "Jelly", "Ice Cube", "Coal"},
    Multi = true,
    Callback = function(Value)
        WorldESP.Items.Filter = {}
        WorldESP.Items.All = false
        if type(Value) == "table" then
            for _, n in ipairs(Value) do
                if n == "ALL ITEMS" then 
                    WorldESP.Items.All = true 
                else 
                    WorldESP.Items.Filter[n] = true 
                end
            end
        end
    end
})

-- Critters ESP Section
local CrittersSection = ESPPage:Section({Name = "Critters ESP", Side = 2})

CrittersSection:Toggle({
    Name = "Enabled",
    Default = false,
    Callback = function(v) WorldESP.Critters.Enabled = v end
})

CrittersSection:Slider({
    Name = "Range",
    Min = 100,
    Max = 5000,
    Default = 1000,
    Callback = function(v) WorldESP.Critters.Range = v end
})

CrittersSection:Dropdown({
    Name = "Critter Filter",
    Items = {"ALL CRITTERS", "Ants", "Goober", "Shelly", "Bird"},
    Multi = true,
    Callback = function(Value)
        WorldESP.Critters.Filter = {}
        WorldESP.Critters.All = false
        if type(Value) == "table" then
            for _, n in ipairs(Value) do
                if n == "ALL CRITTERS" then 
                    WorldESP.Critters.All = true 
                else 
                    WorldESP.Critters.Filter[n] = true 
                end
            end
        end
    end
})

-- Resources ESP Section
local ResourcesSection = ESPPage:Section({Name = "Resources ESP", Side = 2})

ResourcesSection:Toggle({
    Name = "Enabled",
    Default = false,
    Callback = function(v) WorldESP.Resources.Enabled = v end
})

ResourcesSection:Slider({
    Name = "Range",
    Min = 100,
    Max = 5000,
    Default = 2500,
    Callback = function(v) WorldESP.Resources.Range = v end
})

ResourcesSection:Dropdown({
    Name = "Node Filter",
    Items = {"ALL NODES", "GOD NODES", "Stone Node", "Coal Node", "Iron Node", "Gold Node", "Adurite Node", "Crystal Lode"},
    Multi = true,
    Callback = function(Value)
        WorldESP.Resources.Filter = {}
        WorldESP.Resources.All = false
        WorldESP.Resources.Gods = false
        if type(Value) == "table" then
            for _, n in ipairs(Value) do
                if n == "ALL NODES" then 
                    WorldESP.Resources.All = true 
                elseif n == "GOD NODES" then 
                    WorldESP.Resources.Gods = true
                else 
                    WorldESP.Resources.Filter[n] = true 
                end
            end
        end
    end
})

-- =================== PACKET FUNCTIONS ===================
local function swingTool(targets)
    if packets and packets.SwingTool and packets.SwingTool.send then
        packets.SwingTool.send(targets)
    end
end

local function pickupItem(entityid)
    if packets and packets.Pickup and packets.Pickup.send then
        packets.Pickup.send(entityid)
    end
end

local function dropItemByName(itemName)
    if itemName == "All" then
        local inventory = plr.PlayerGui:FindFirstChild("MainGui")
        if not inventory then return end
        inventory = inventory:FindFirstChild("RightPanel")
        if not inventory then return end
        inventory = inventory:FindFirstChild("Inventory")
        if not inventory then return end
        local list = inventory:FindFirstChild("List")
        if not list then return end
        
        for _, child in ipairs(list:GetChildren()) do
            if child:IsA("ImageLabel") and child.Name ~= "" then
                if packets and packets.DropBagItem and packets.DropBagItem.send then
                    packets.DropBagItem.send(child.LayoutOrder)
                end
            end
        end
    else
        local inventory = plr.PlayerGui:FindFirstChild("MainGui")
        if not inventory then return end
        inventory = inventory:FindFirstChild("RightPanel")
        if not inventory then return end
        inventory = inventory:FindFirstChild("Inventory")
        if not inventory then return end
        local list = inventory:FindFirstChild("List")
        if not list then return end
        
        for _, child in ipairs(list:GetChildren()) do
            if child:IsA("ImageLabel") and child.Name == itemName then
                if packets and packets.DropBagItem and packets.DropBagItem.send then
                    packets.DropBagItem.send(child.LayoutOrder)
                end
            end
        end
    end
end

local function useBagItem(layoutOrder)
    if packets and packets.UseBagItem and packets.UseBagItem.send then
        packets.UseBagItem.send(layoutOrder)
    end
end

local function interactStructure(data)
    if packets and packets.InteractStructure and packets.InteractStructure.send then
        packets.InteractStructure.send(data)
    end
end

local function getHealth()
    local mainGui = plr.PlayerGui:FindFirstChild("MainGui")
    if not mainGui then return 100 end
    
    local stats = mainGui:FindFirstChild("Panels")
    if not stats then return 100 end
    stats = stats:FindFirstChild("Stats")
    if not stats then return 100 end
    local bars = stats:FindFirstChild("Bars")
    if not bars then return 100 end
    local healthBar = bars:FindFirstChild("Health")
    if not healthBar then return 100 end
    local valueLabel = healthBar:FindFirstChild("ValueLabel")
    if not valueLabel then return 100 end
    
    if valueLabel.Text then
        return tonumber(valueLabel.Text:match("%d+")) or 100
    end
    return 100
end

local function getHunger()
    local mainGui = plr.PlayerGui:FindFirstChild("MainGui")
    if not mainGui then return 100 end
    
    local stats = mainGui:FindFirstChild("Panels")
    if not stats then return 100 end
    stats = stats:FindFirstChild("Stats")
    if not stats then return 100 end
    local bars = stats:FindFirstChild("Bars")
    if not bars then return 100 end
    local hungerBar = bars:FindFirstChild("Hunger")
    if not hungerBar then return 100 end
    local valueLabel = hungerBar:FindFirstChild("ValueLabel")
    if not valueLabel then return 100 end
    
    if valueLabel.Text then
        return tonumber(valueLabel.Text:match("%d+")) or 100
    end
    return 100
end

local function getInventoryItem(itemName)
    local mainGui = plr.PlayerGui:FindFirstChild("MainGui")
    if not mainGui then return nil end
    
    local rightPanel = mainGui:FindFirstChild("RightPanel")
    if not rightPanel then return nil end
    
    local inventory = rightPanel:FindFirstChild("Inventory")
    if not inventory then return nil end
    
    local list = inventory:FindFirstChild("List")
    if not list then return nil end
    
    for _, child in ipairs(list:GetChildren()) do
        if child:IsA("ImageLabel") and child.Name == itemName then
            return child
        end
    end
    return nil
end

-- =================== PLAYER ESP FUNCTIONS ===================
local function createPlayerESP(p)
    if p == plr then return end
    
    local bgui = Instance.new("BillboardGui", game.CoreGui)
    bgui.Name = p.Name .. "_PlayerESP"
    bgui.AlwaysOnTop = true
    bgui.Size = UDim2.new(0, 250, 0, 100)
    bgui.ExtentsOffset = Vector3.new(0, 3.5, 0)

    local container = Instance.new("Frame", bgui)
    container.Size = UDim2.new(1, 0, 1, 0)
    container.BackgroundTransparency = 1

    local function createLabel(size, pos, fontSize)
        local lbl = Instance.new("TextLabel", container)
        lbl.Size = size
        lbl.Position = pos
        lbl.BackgroundTransparency = 1
        lbl.Font = Enum.Font.GothamBold
        lbl.TextSize = fontSize
        lbl.TextStrokeTransparency = 0
        lbl.TextStrokeColor3 = Color3.new(0, 0, 0)
        return lbl
    end

    local nameLabel = createLabel(UDim2.new(1, 0, 0, 22), UDim2.new(0, 0, 0, 0), 18)
    local infoLabel = createLabel(UDim2.new(1, 0, 0, 18), UDim2.new(0, 0, 0, 22), 14)

    runs.RenderStepped:Connect(function()
        local tChar = workspace.Players:FindFirstChild(p.Name)
        if not espEnabled or not tChar or not tChar:FindFirstChild("HumanoidRootPart") then
            bgui.Enabled = false
            return
        end
        
        local dist = (tChar.HumanoidRootPart.Position - root.Position).Magnitude
        if dist > espMaxDistance then
            bgui.Enabled = false
            return
        end

        bgui.Adornee = tChar.HumanoidRootPart
        bgui.Enabled = true

        local color = p.TeamColor and p.TeamColor.Color or Color3.fromRGB(255, 255, 255)
        nameLabel.TextColor3 = color
        infoLabel.TextColor3 = color
        
        local playerName = p.Name or "Unknown"
        local distanceText = math.floor(dist) or 0
        nameLabel.Text = playerName .. " [" .. distanceText .. "m]"

        local details = {}
        if espShowHP and tChar:FindFirstChild("Humanoid") then
            local health = math.floor(tChar.Humanoid.Health) or 0
            table.insert(details, "HP: " .. health)
        end
        
        if espShowArmor then
            local armor = {}
            for _, v in pairs(tChar:GetChildren()) do
                if v.Name:lower():find("chest") or v.Name:lower():find("greaves") or v.Name:lower():find("helmet") then
                    table.insert(armor, v.Name:match("^%S+") or v.Name)
                end
            end
            if #armor > 0 then
                table.insert(details, "A: " .. table.concat(armor, "/"))
            else
                table.insert(details, "A: None")
            end
        end
        
        if espShowWeapon then
            local tools = tChar:FindFirstChild("Tools")
            local weapon = tools and (tools:FindFirstChildWhichIsA("Model") or tools:FindFirstChildWhichIsA("BasePart"))
            table.insert(details, "W: " .. (weapon and weapon.Name or "None"))
        end
        
        infoLabel.Text = table.concat(details, " â€¢ ")
    end)
end

local function createESPForAllPlayers()
    for _, p in pairs(game.Players:GetPlayers()) do
        if p ~= plr then
            createPlayerESP(p)
        end
    end
end

local function clearESP()
    for _, p in pairs(game.Players:GetPlayers()) do
        if p ~= plr then
            local esp = game.CoreGui:FindFirstChild(p.Name .. "_PlayerESP")
            if esp then esp:Destroy() end
        end
    end
end

-- =================== WORLD ESP FUNCTIONS (YOUR OLD CODE) ===================
local function ApplyESP(obj, text, color, visible, showStuds)
    local esp = obj:FindFirstChild("NevoxESP")
    
    if visible then
        if not esp then
            esp = Instance.new("BillboardGui")
            esp.Name = "NevoxESP"
            esp.AlwaysOnTop = true
            esp.Size = UDim2.new(0, 100, 0, 50)
            esp.LightInfluence = 0
            
            local label = Instance.new("TextLabel", esp)
            label.BackgroundTransparency = 1
            label.Size = UDim2.new(1, 0, 1, 0)
            label.TextColor3 = color
            label.TextStrokeTransparency = 0
            label.TextStrokeColor3 = Color3.new(0,0,0)
            label.Font = Enum.Font.RobotoMono
            label.TextSize = 16
            esp.Parent = obj
        end
        
        local str = text
        if showStuds and root then
            local dist = math.floor((obj:GetPivot().Position - root.Position).Magnitude)
            str = text .. "\n[" .. dist .. "m]"
        end
        
        -- Only update text if it actually changed to prevent flickering
        if esp.TextLabel.Text ~= str then
            esp.TextLabel.Text = str
        end
        esp.Enabled = true
    else
        if esp then
            esp:Destroy() -- Use Destroy here to fully clean up when toggled off
        end
    end
end

-- =================== TWEEN FUNCTIONS ===================
local function safeTween(targetPosition)
    if currentTween then
        currentTween:Cancel()
        currentTween = nil
    end
    
    local params = RaycastParams.new()
    params.FilterDescendantsInstances = {char}
    params.FilterType = Enum.RaycastFilterType.Blacklist
    
    local direction = (targetPosition - root.Position).Unit
    local distance = (targetPosition - root.Position).Magnitude
    local raycastResult = workspace:Raycast(root.Position, direction * distance, params)
    
    if raycastResult then
        -- Obstacle detected, use pathfinding
        local path = pathService:CreatePath()
        path:ComputeAsync(root.Position, targetPosition)
        
        if path.Status == Enum.PathStatus.Success then
            local waypoints = path:GetWaypoints()
            for _, waypoint in ipairs(waypoints) do
                if waypoint.Action == Enum.PathWaypointAction.Jump then
                    hum.Jump = true
                end
                
                local tweenInfo = TweenInfo.new(
                    (waypoint.Position - root.Position).Magnitude / tweenSpeed,
                    Enum.EasingStyle.Linear
                )
                
                currentTween = tspmo:Create(root, tweenInfo, {CFrame = CFrame.new(waypoint.Position)})
                currentTween:Play()
                currentTween.Completed:Wait()
                
                if not tweenPlantBoxEnabled and not tweenBushEnabled then
                    break
                end
            end
        else
            -- If pathfinding fails, use direct tween but with obstacle avoidance
            local tweenInfo = TweenInfo.new(distance / tweenSpeed, Enum.EasingStyle.Linear)
            currentTween = tspmo:Create(root, tweenInfo, {CFrame = CFrame.new(targetPosition)})
            currentTween:Play()
        end
    else
        -- No obstacles, direct tween
        local tweenInfo = TweenInfo.new(distance / tweenSpeed, Enum.EasingStyle.Linear)
        currentTween = tspmo:Create(root, tweenInfo, {CFrame = CFrame.new(targetPosition)})
        currentTween:Play()
    end
end

local function getPlantBoxes(range)
    local plantboxes = {}
    for _, deployable in ipairs(workspace.Deployables:GetChildren()) do
        if deployable:IsA("Model") and deployable.Name == "Plant Box" then
            local entityid = deployable:GetAttribute("EntityID")
            local ppart = deployable.PrimaryPart or deployable:FindFirstChildWhichIsA("BasePart")
            if entityid and ppart then
                local dist = (ppart.Position - root.Position).Magnitude
                if dist <= range then
                    table.insert(plantboxes, { entityid = entityid, deployable = deployable, dist = dist })
                end
            end
        end
    end
    return plantboxes
end

local function getBushes(range, fruitname)
    local bushes = {}
    for _, model in ipairs(workspace:GetChildren()) do
        if model:IsA("Model") and string.find(string.lower(model.Name), string.lower(fruitname)) then
            local ppart = model.PrimaryPart or model:FindFirstChildWhichIsA("BasePart")
            if ppart then
                local dist = (ppart.Position - root.Position).Magnitude
                if dist <= range then
                    local entityid = model:GetAttribute("EntityID")
                    if entityid then
                        table.insert(bushes, { entityid = entityid, model = model, dist = dist })
                    end
                end
            end
        end
    end
    return bushes
end

-- =================== MAIN LOOPS ===================
-- Auto Pickup Loop (FIXED - Now uses correct dropdown implementation)
task.spawn(function()
    while true do
        if autoPickupEnabled and root then
            local itemsFolder = workspace:FindFirstChild("Items")
            if itemsFolder then
                for _, item in ipairs(itemsFolder:GetChildren()) do
                    local shouldPick = false
                    
                    -- Check if "ALL ITEMS" is selected
                    if PickAllMode then
                        shouldPick = true
                    -- Otherwise check individual selection
                    elseif selectedItems[item.Name] then
                        shouldPick = true
                    end
                    
                    -- Custom Pickup (works independently)
                    if customPickupEnabled and customPickupText ~= "" then
                        if string.find(string.lower(item.Name), string.lower(customPickupText)) then
                            shouldPick = true
                        end
                    end

                    if shouldPick then
                        local itemPos = item:GetPivot().Position
                        local dist = (itemPos - root.Position).Magnitude
                        
                        if dist <= pickupRange then
                            local id = item:GetAttribute("EntityID") or item:GetAttribute("ID")
                            
                            if id and packets.Pickup and packets.Pickup.send then
                                pcall(function()
                                    packets.Pickup.send(id)
                                end)
                            end
                        end
                    end
                end
            end
            
            -- Chest Pickup
            if chestPickupEnabled then
                for _, chest in ipairs(workspace.Deployables:GetChildren()) do
                    if chest:IsA("Model") and chest:FindFirstChild("Contents") then
                        for _, item in ipairs(chest.Contents:GetChildren()) do
                            local shouldPick = false
                            
                            if PickAllMode then
                                shouldPick = true
                            elseif selectedItems[item.Name] then
                                shouldPick = true
                            end
                            
                            if shouldPick then
                                local dist = (chest.PrimaryPart.Position - root.Position).Magnitude
                                if dist <= pickupRange then
                                    local id = item:GetAttribute("EntityID")
                                    if id then
                                        pcall(function()
                                            packets.Pickup.send(id)
                                        end)
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end
        task.wait(0.01)
    end
end)

-- Kill Aura Loop
task.spawn(function()
    while true do
        if killAuraEnabled then
            local targets = {}
            for _, p in pairs(game.Players:GetPlayers()) do
                if p ~= plr then
                    local folder = workspace.Players:FindFirstChild(p.Name)
                    if folder then
                        local eid = folder:GetAttribute("EntityID")
                        local hrp = folder:FindFirstChild("HumanoidRootPart")
                        if eid and hrp then
                            local dist = (hrp.Position - root.Position).Magnitude
                            if dist <= killAuraRange then
                                table.insert(targets, {eid = eid, dist = dist})
                            end
                        end
                    end
                end
            end
            
            if #targets > 0 then
                table.sort(targets, function(a,b) return a.dist < b.dist end)
                local selected = {}
                for i = 1, math.min(#targets, killAuraMaxTargets) do
                    table.insert(selected, targets[i].eid)
                end
                swingTool(selected)
            end
        end
        task.wait(killAuraCooldown)
    end
end)

-- Resource Aura Loop
task.spawn(function()
    while true do
        if resourceAuraEnabled then
            local targets = {}
            
            for _, resource in ipairs(workspace.Resources:GetChildren()) do
                if resource:IsA("Model") then
                    local entityId = resource:GetAttribute("EntityID")
                    local part = resource.PrimaryPart or resource:FindFirstChildWhichIsA("BasePart")
                    if entityId and part then
                        local dist = (part.Position - root.Position).Magnitude
                        if dist <= resourceRange then
                            table.insert(targets, {eid = entityId, dist = dist})
                        end
                    end
                end
            end
            
            if #targets > 0 then
                table.sort(targets, function(a,b) return a.dist < b.dist end)
                local selected = {}
                for i = 1, math.min(#targets, resourceMaxTargets) do
                    table.insert(selected, targets[i].eid)
                end
                swingTool(selected)
            end
        end
        task.wait(resourceCooldown)
    end
end)

-- Critter Aura Loop
task.spawn(function()
    while true do
        if critterAuraEnabled then
            local targets = {}
            
            for _, critter in ipairs(workspace.Critters:GetChildren()) do
                if critter:IsA("Model") then
                    local entityId = critter:GetAttribute("EntityID")
                    local part = critter.PrimaryPart or critter:FindFirstChildWhichIsA("BasePart")
                    if entityId and part then
                        local dist = (part.Position - root.Position).Magnitude
                        if dist <= critterRange then
                            table.insert(targets, {eid = entityId, dist = dist})
                        end
                    end
                end
            end
            
            if #targets > 0 then
                table.sort(targets, function(a,b) return a.dist < b.dist end)
                local selected = {}
                for i = 1, math.min(#targets, critterMaxTargets) do
                    table.insert(selected, targets[i].eid)
                end
                swingTool(selected)
            end
        end
        task.wait(critterCooldown)
    end
end)

-- Auto Heal/Eat Loop
task.spawn(function()
    while true do
        if autoHealEnabled then
            local hp = getHealth()
            if hp < autoHealThreshold then
                local item = getInventoryItem(autoHealFruit)
                if item then
                    useBagItem(item.LayoutOrder)
                    task.wait(1/autoEatCPS)
                end
            end
        end

        if autoEatEnabled then
            local hunger = getHunger()
            if hunger < autoEatThreshold then
                local item = getInventoryItem(autoEatFruit)
                if item then
                    useBagItem(item.LayoutOrder)
                    task.wait(1/autoEatCPS)
                end
            end
        end
        task.wait(0.05)
    end
end)

-- Auto Drop Loop
task.spawn(function()
    while true do
        if autoDropEnabled then
            dropItemByName(dropItem)
            task.wait(dropCooldown)
        end
        
        if autoDropCustomEnabled then
            dropItemByName(customDropItem)
            task.wait(dropCooldown)
        end
        task.wait(0.001)
    end
end)

-- Auto Plant Loop
task.spawn(function()
    while true do
        if plantToggle then
            local itemID = fruitToItemId[selectedFruit] or 94
            local plantboxes = getPlantBoxes(plantRange)
            table.sort(plantboxes, function(a, b) return a.dist < b.dist end)

            for _, box in ipairs(plantboxes) do
                if not box.deployable:FindFirstChild("Seed") then
                    interactStructure({entityID = box.entityid, itemID = itemID})
                end
            end
        end
        task.wait(plantDelay)
    end
end)

-- Auto Harvest Loop
task.spawn(function()
    while true do
        if harvestToggle then
            local bushes = getBushes(harvestRange, selectedFruit)
            table.sort(bushes, function(a, b) return a.dist < b.dist end)
            for _, bush in ipairs(bushes) do
                pickupItem(bush.entityid)
            end
        end
        task.wait(0.05)
    end
end)

-- Tween Plant Box Loop
task.spawn(function()
    while true do
        if tweenPlantBoxEnabled then
            local plantboxes = getPlantBoxes(tweenRange)
            table.sort(plantboxes, function(a, b) return a.dist < b.dist end)

            for _, box in ipairs(plantboxes) do
                if not box.deployable:FindFirstChild("Seed") then
                    safeTween(box.deployable.PrimaryPart.Position + Vector3.new(0, 5, 0))
                    break
                end
            end
        end
        task.wait(0.1)
    end
end)

-- Tween Bush Loop
task.spawn(function()
    while true do
        if tweenBushEnabled then
            local bushes = getBushes(tweenRange, selectedFruit)
            table.sort(bushes, function(a, b) return a.dist < b.dist end)

            if #bushes > 0 then
                for _, bush in ipairs(bushes) do
                    safeTween(bush.model.PrimaryPart.Position + Vector3.new(0, 5, 0))
                    break
                end
            else
                local plantboxes = getPlantBoxes(tweenRange)
                table.sort(plantboxes, function(a, b) return a.dist < b.dist end)

                for _, box in ipairs(plantboxes) do
                    if not box.deployable:FindFirstChild("Seed") then
                        safeTween(box.deployable.PrimaryPart.Position + Vector3.new(0, 5, 0))
                        break
                    end
                end
            end
        end
        task.wait(0.1)
    end
end)

-- Door Utility Auto-Delete Loop
task.spawn(function()
    while task.wait(1) do
        if delHut then ProcessDoors("Hut", true) end
        if delGate then ProcessDoors("Gate", true) end
    end
end)

-- Using Heartbeat for the check logic (YOUR OLD ESP CODE)
RunService.Heartbeat:Connect(function()
    if not root then return end

    -- 1. ITEMS ESP
    local items = workspace:FindFirstChild("Items")
    if items then
        for _, item in ipairs(items:GetChildren()) do
            local d = (item:GetPivot().Position - root.Position).Magnitude
            local active = WorldESP.Items.Enabled and d <= WorldESP.Items.Range and (WorldESP.Items.All or WorldESP.Items.Filter[item.Name])
            ApplyESP(item, item.Name, Color3.fromRGB(255, 255, 255), active, false)
        end
    end

    -- 2. CRITTERS ESP
    local critters = workspace:FindFirstChild("Critters")
    if critters then
        for _, crit in ipairs(critters:GetChildren()) do
            local d = (crit:GetPivot().Position - root.Position).Magnitude
            local isAnt = string.find(crit.Name, "Ant")
            local isShelly = string.find(crit.Name, "Shelly")
            local match = WorldESP.Critters.All or WorldESP.Critters.Filter[crit.Name] or (WorldESP.Critters.Filter["Ants"] and isAnt) or (WorldESP.Critters.Filter["Shelly"] and isShelly)
            local active = WorldESP.Critters.Enabled and d <= WorldESP.Critters.Range and match
            ApplyESP(crit, crit.Name, Color3.fromRGB(0, 255, 255), active, false)
        end
    end

    -- 3. RESOURCES ESP
    local resources = workspace:FindFirstChild("Resources")
    if resources then
        for _, node in ipairs(resources:GetChildren()) do
            local d = (node:GetPivot().Position - root.Position).Magnitude
            local isGod = string.find(string.lower(node.Name), "god")
            local match = WorldESP.Resources.All or WorldESP.Resources.Filter[node.Name] or (WorldESP.Resources.Gods and isGod)
            local active = WorldESP.Resources.Enabled and d <= WorldESP.Resources.Range and match
            
            local col = (isGod or string.find(node.Name, "Gold")) and Color3.fromRGB(255, 215, 0) or Color3.fromRGB(0, 255, 0)
            ApplyESP(node, node.Name, col, active, true)
        end
    end
end)

-- Character Added Event
plr.CharacterAdded:Connect(function(new)
    char = new
    root = new:WaitForChild("HumanoidRootPart")
    hum = new:WaitForChild("Humanoid")
    
    originalValues = {
        WalkSpeed = hum.WalkSpeed,
        JumpPower = hum.JumpPower,
        HipHeight = hum.HipHeight,
        MaxSlopeAngle = hum.MaxSlopeAngle
    }
    
    canDoubleJump = false
    hasDoubleJumped = false
    
    if wstoggle:Get() then updateWalkspeed(true) end
    if jptoggle:Get() then updateJumpPower(true) end
    if hheighttoggle:Get() then updateHipHeight(true) end
    if msatoggle:Get() then updateNoSlip(true) end
    if doublejumptoggle:Get() then updateDoubleJump(true) end
end)

-- ESP Player Events
game.Players.PlayerAdded:Connect(function(p)
    if p ~= plr and espEnabled then
        createPlayerESP(p)
    end
end)

game.Players.PlayerRemoving:Connect(function(p)
    local esp = game.CoreGui:FindFirstChild(p.Name .. "_PlayerESP")
    if esp then esp:Destroy() end
end)

-- Initialize ESP for existing players if enabled
if espEnabled then
    createESPForAllPlayers()
end

-- Initialize UI
Window:Init()

getgenv().Library = Library
